<html lang="ja">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<title>Spoken Dialog by Javascript</title>
</head>
<body>

<h1>キーワードの部分一致（単純な正規表現の利用）</h1>

<p>
<button id="startButton">start</button>
<button id="stopButton">stop</button>
</p>

<p>
<div id="resultOutput"></div>
</p>

<script>
// 応答の定義（ハッシュ）
var response = {
    "あなたは誰": {
        keywords: ["あなたは誰"],
        response: "わたしはアレクサではありません"
    },
    "名前は": {
        keywords: ["名前は"],
        response: "内緒です"
    },
    "何歳": {
        keywords: ["何歳"],
        response: "え、わたし、何歳にみえますか"
    },
    "元気": {
        keywords: ["元気"],
        response: "元気ですよー"
    },
    "好きな色": {
        keywords: ["好きな", "色"],
        response: "オレンジです"
    },
    "夢は": {
        keywords: ["夢は"],
        response: "世界を冒険することです"
    },
    "好きなスポーツ": {
        keywords: ["好きな", "スポーツ"],
        response: "けん玉です"
    },
    "好きな食べ物": {
        keywords: ["好きな", "食べ物"],
        response: "焼肉です"
    },
    "和歌山の天気": {
        keywords: ["和歌山", "天気"],
        response: "和歌山県の天気予報を表示します",
        webpage: "https://weather.yahoo.co.jp/weather/jp/30/"
    },
    "大阪の天気": {
        keywords: ["大阪", "天気"],
        response: "大阪府の天気予報を表示します",
        webpage: "https://weather.yahoo.co.jp/weather/jp/27/"
    },
    "京都の天気": {
        keywords: ["京都", "天気"],
        response: "京都府の天気予報を表示します",
        webpage: "https://weather.yahoo.co.jp/weather/jp/26/"
    },
    "奈良の天気": {
        keywords: ["奈良", "天気"],
        response: "奈良県の天気予報を表示します",
        webpage: "https://weather.yahoo.co.jp/weather/jp/29/"
    },
    "兵庫の天気": {
        keywords: ["兵庫", "天気"],
        response: "兵庫県の天気予報を表示します",
        webpage: "https://weather.yahoo.co.jp/weather/jp/28/"
    }
};

const startButton = document.querySelector('#startButton'); // 開始ボタン
const stopButton = document.querySelector('#stopButton'); // 停止ボタン
const resultOutput = document.querySelector('#resultOutput'); // 結果出力エリア

if (!'SpeechSynthesisUtterance' in window) {
    alert("あなたのブラウザはSpeech Synthesis APIに未対応です。");
}
const tts = new SpeechSynthesisUtterance(); // TTSインスタンスを生成
tts.lang = "ja-JP"; // 言語(日本語)```javascript
const asr = new webkitSpeechRecognition(); // 音声認識インスタンスを生成
asr.lang = "ja-JP"; // 言語(日本語)
asr.continuous = true; // 連続認識モードに設定
asr.interimResults = true; // 途中結果を取得するよう設定

// 変数の初期化
let output = '';

// 認識結果が出力されたときのイベントハンドラ
asr.onresult = function(event) {
    let transcript = event.results[event.resultIndex][0].transcript; // 結果文字列

    let output_not_final = '';
    if (event.results[event.resultIndex].isFinal) { // 結果が確定（Final）のとき
        asr.abort(); // 音声認識を停止

        let matchedResponse = null;
        for (let key in response) {
            let keywords = response[key].keywords;
            let isMatch = keywords.every(function(keyword) {
                return transcript.includes(keyword);
            });

            if (isMatch) {
                matchedResponse = response[key];
                break;
            }
        }

        let answer;
        let webpage;

        if (matchedResponse === null) {
            answer = "ごめんなさい。わかりません。";
        } else {
            answer = matchedResponse.response;
            webpage = matchedResponse.webpage;
        }

        output += transcript + ' => ' + answer + '<br>';

        tts.text = answer;
        // 再生が終了（end）ときのイベントハンドラ（終了したときに実行される）
        tts.onend = function(event) {
            if (typeof webpage !== 'undefined') {
                window.open(webpage, "_blank"); // 新しいウィンドウでページを開く
            }
            asr.start(); // 音声認識を再開
        }

        speechSynthesis.speak(tts); // 再生
    } else { // 結果がまだ未確定のとき
        output_not_final = '<span style="color:#ddd;">' + transcript + '</span>';
    }
    resultOutput.innerHTML = output + output_not_final;
}

// 開始ボタンのイベントハンドラ
startButton.addEventListener('click', function() {
    asr.start();
})

// 停止ボタンのイベントハンドラ
stopButton.addEventListener('click', function() {
    asr.abort();
    asr.stop();
})
</script>



</body>
</html>