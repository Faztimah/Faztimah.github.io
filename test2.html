<html lang="ja">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<title>Spoken Dialog by Javascript</title>
</head>
<body>

<h1>キーワードの部分一致（単純な正規表現の利用）</h1>

<p>
<button id="startButton">start</button>
<button id="stopButton">stop</button>
</p>

<p>
<div id="resultOutput"></div>
</p>

<script>

<script>
// 応答の定義（ハッシュ）
var response = {
    "あなたは誰": {
        keywords: ["あなたは誰"],
        response: "わたしはアレクサではありません"
    },
    "名前は": {
        keywords: ["名前は"],
        response: "内緒です"
    },
    "何歳": {
        keywords: ["何歳"],
        response: "え、わたし、何歳にみえますか"
    },
    "元気": {
        keywords: ["元気"],
        response: "元気ですよー"
    },
    "好きな色": {
        keywords: ["好きな", "色"],
        response: "オレンジです"
    },
    "夢は": {
        keywords: ["夢は"],
        response: "世界を冒険することです"
    },
    "好きなスポーツ": {
        keywords: ["好きな", "スポーツ"],
        response: "けん玉です"
    },
    "好きな食べ物": {
        keywords: ["好きな", "食べ物"],
        response: "焼肉です"
    },
    "和歌山の天気": {
        keywords: ["和歌山", "天気"],
        response: "和歌山県の天気予報を表示します",
        webpage: "https://weather.yahoo.co.jp/weather/jp/30/"
    },
    "大阪の天気": {
        keywords: ["大阪", "天気"],
        response: "大阪府の天気予報を表示します",
        webpage: "https://weather.yahoo.co.jp/weather/jp/27/"
    },
    "京都の天気": {
        keywords: ["京都", "天気"],
        response: "京都府の天気予報を表示します",
        webpage: "https://weather.yahoo.co.jp/weather/jp/26/"
    },
    "奈良の天気": {
        keywords: ["奈良", "天気"],
        response: "奈良県の天気予報を表示します",
        webpage: "https://weather.yahoo.co.jp/weather/jp/29/"
    },
    "兵庫の天気": {
        keywords: ["兵庫", "天気"],
        response: "兵庫県の天気予報を表示します",
        webpage: "https://weather.yahoo.co.jp/weather/jp/28/"
    }
};

const URL = "https://jlp.yahooapis.jp/NLUService/V2/analyze?appid="; // APIのリクエストURL
const APPID = "dj00aiZpPW1iSUlzS2Q2YnJicyZzPWNvbnN1bWVyc2VjcmV0Jng9ZGI-"; // あなたのアプリケーションID
const queryURL = URL + APPID;

const startButton = document.querySelector('#startButton'); // 開始ボタン
const stopButton = document.querySelector('#stopButton');
const resultOutput = document.querySelector('#resultOutput'); // 結果表示領域

// 音声認識オブジェクトの作成
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const asr = new SpeechRecognition();

asr.lang = 'ja-JP'; // 言語を日本語に設定
asr.continuous = true; // 継続的な結果取得を有効にする

// 音声認識が開始されたときのイベントハンドラ
asr.onstart = function () {
    console.log('音声認識開始');
};

// 音声認識結果が取得されたときのイベントハンドラ
asr.onresult = function (event) {
    let transcript = event.results[event.resultIndex][0].transcript; // 結果文字列

    let output_not_final = '';
    if (event.results[event.resultIndex].isFinal) { // 結果が確定（Final）のとき
        asr.abort(); // 音声認識を停止

        let matchedResponse = null;
        for (const key in response) {
            const keywords = response[key].keywords;
            const isMatched = keywords.every(keyword => transcript.includes(keyword));

            if (isMatched) {
                matchedResponse = response[key];
                break;
            }
        }

        if (matchedResponse) {
            let answer = matchedResponse.response;
            let webpage = matchedResponse.webpage;

            if (typeof answer === 'undefined' || typeof webpage === 'undefined') {
                // 応答が未定義またはウェブページが未定義の場合、Yahoo Japan APIを使用する
                // HTTPリクエストの準備
                var postdata = {
                    "id": "1234-1", // JSON-RPC2.0 id、値は任意で、指定した値がレスポンスのidになる。
                    "jsonrpc": "2.0", // APIで固定
                    "method": "jlp.nluservice.analyze", // APIで固定
                    "params": { "q": transcript }, // 解析対象のテキスト 
                };
                var jsondata = JSON.stringify(postdata);

                const request = new XMLHttpRequest();
                request.open('POST', queryURL, true);
                request.setRequestHeader('Content-Type', 'application/json');
                request.responseType = 'json'; // レスポンスはJSON形式に変換

                // HTTPの状態が変化したときのイベントハンドラ
                request.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        // readyState == 4 操作完了
                        // status == 200 リクエスト成功（HTTPレスポンス）

                        let res = this.response; // 結果はJSON形式

                        Object.keys(res.result).forEach(function (key) {
                            console.log(key + ": " + res.result[key])
                        });

                        // METHOD が SAY のときのみ
                        if (res.result.METHOD == "SAY") {
                            answer = res.result.PARAM_TEXT_TTS || res.result.PARAM_TEXT;
                            tts.text = answer;

                            // 再生が終了（end）ときのイベントハンドラ（終了したときに実行される）
                            tts.onend = function (event) {
                                asr.start(); // 音声認識を再開
                            }

                            output += transcript + ' => ' + answer + '<br>';
                            resultOutput.innerHTML = output;
                            speechSynthesis.speak(tts); // 再生
                        } else {
                            asr.start();  // 音声認識を再開
                        }
                    }
                };
                // HTTPリクエストの実行
                request.send(jsondata);
            } else {
                // 応答とウェブページが定義されている場合
                output += transcript + ' => ' + answer + '<br>';

                tts.text = answer;
                // 再生が終了（end）ときのイベントハンドラ（終了したときに実行される）
                tts.onend = function (event) {
                    location.href = webpage; // ページを移動
                }

                resultOutput.innerHTML = output;
                speechSynthesis.speak(tts); // 再生
            }
        } else {
            let answer = "ごめんなさい。わかりません。";
            output += transcript + ' => ' + answer + '<br>';

            tts.text = answer;
            // 再生が終了（end）ときのイベントハンドラ（終了したときに実行される）
            tts.onend = function (event) {
                asr.start(); // 音声認識を再開
            }

            resultOutput.innerHTML = output;
            speechSynthesis.speak(tts); // 再生
        }
    } else { // 結果がまだ未確定のとき
        output_not_final = '<span style="color:#ddd;">' + transcript + '</span>';
        resultOutput.innerHTML = output + output_not_final;
    }
};

// 開始ボタンがクリックされたときのイベントハンドラ
startButton.onclick = function () {
    asr.start(); // 音声認識を開始
};

// 停止ボタンがクリックされたときのイベントハンドラ
stopButton.onclick = function () {
    asr.abort(); // 音声認識を停止
};

</script>

</script>

</body>
</html>